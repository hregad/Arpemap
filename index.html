<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartographie des Spectromètres - France</title>
    
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <script src="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.5.0/dist/maplibre-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.5.0/dist/maplibre-gl-geocoder.css" type="text/css" />

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* Sidebar Style */
        #sidebar {
            position: absolute;
            top: 0; left: 0;
            width: 300px;
            height: 100%;
            background: white;
            z-index: 2;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #sidebar.collapsed { transform: translateX(-300px); }
        
        #toggle-sidebar {
            position: absolute;
            top: 15px; left: 310px;
            z-index: 3;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            padding: 8px 12px;
            transition: left 0.3s ease;
        }
        #sidebar.collapsed + #toggle-sidebar { left: 10px; }

        .menu-section { margin-bottom: 25px; }
        h3 { font-size: 1.1em; color: #333; margin-top: 0; }
        
        .btn-home {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: block;
            text-align: center;
            margin-top: auto;
        }
        
        /* Custom Controls */
        .map-overlay {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1;
        }
        
        .layer-switcher label { display: block; cursor: pointer; font-size: 0.9em; }
        .btn-3d { margin-top: 10px; width: 100%; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h3>Recherche & Filtres</h3>
        
        <div class="menu-section">
            <label>Filtrer par type :</label><br>
            <select id="filter-type" style="width: 100%; padding: 5px; margin-top: 5px;">
                <option value="all">Tous les types</option>
                <option value="Masse">Masse</option>
                <option value="RMN">RMN</option>
                <option value="Infrarouge">Infrarouge</option>
            </select>
        </div>

        <div class="menu-section">
            <p><small>Cliquez sur un groupe pour zoomer ou sur un point pour voir les détails techniques.</small></p>
        </div>

        <a href="#" class="btn-home">Retour Accueil</a>
    </div>

    <button id="toggle-sidebar">☰</button>

    <div id="map"></div>

    <div class="map-overlay">
        <div class="layer-switcher">
            <label><input type="radio" name="basemap" value="ign" checked> IGN Plan </label>
            <label><input type="radio" name="basemap" value="esri"> ESRI Satellite</label>
        </div>
        <button class="btn-3d" id="btn-3d">Vue 3D / 2D</button>
    </div>

    <script>
        // Configuration des sources
        const sources = {
            ign: 'https://data.geopf.fr/wmts?SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&FORMAT=image/png&STYLE=normal',
            esri: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
        };

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'raster-tiles': {
                        type: 'raster',
                        tiles: [sources.ign],
                        tileSize: 256,
                        attribution: '© IGN'
                    }
                },
                layers: [{ id: 'simple-tiles', type: 'raster', source: 'raster-tiles', minzoom: 0, maxzoom: 22 }]
            },
            center: [2.2137, 46.2276], // Centre de la France
            zoom: 5
        });

        // Contrôles standards
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
        map.addControl(new maplibregl.ScaleControl(), 'bottom-left');
        
        // Géocodeur (Recherche)
        const geocoderApi = {
            forwardGeocode: async (config) => {
                const features = [];
                try {
                    const request = `https://nominatim.openstreetmap.org/search?q=${config.query}&format=geojson&addressdetails=1&limit=5`;
                    const response = await fetch(request);
                    const geojson = await response.json();
                    for (let feature of geojson.features) {
                        features.push(feature);
                    }
                } catch (e) { console.error(`Failed to forwardGeocode with error: ${e}`); }
                return { features };
            }
        };
        map.addControl(new MaplibreGeocoder(geocoderApi, { maplibregl: maplibregl }), 'top-right');

        map.on('load', () => {
            // Ajout du fichier GeoJSON avec Clustering
            map.addSource('spectros', {
                type: 'geojson',
                data: './spectrometres.geojson', // Chemin relatif vers ton fichier
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50
            });

            // Layer Clusters (cercles)
            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'spectros',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 3, '#f1f075', 7, '#f28cb1'],
                    'circle-radius': ['step', ['get', 'point_count'], 20, 3, 30, 7, 40]
                }
            });

            // Texte des clusters (nombres)
            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'spectros',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count}',
                    'text-font': ['Open Sans Regular'],
                    'text-size': 12
                }
            });

            // Points individuels (non clusterisés)
            map.addLayer({
                id: 'unclustered-point',
                type: 'circle',
                source: 'spectros',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#0078d4',
                    'circle-radius': 8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff'
                }
            });

            // -- Événements --

            // Zoom sur cluster
            map.on('click', 'clusters', (e) => {
                const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                const clusterId = features[0].properties.cluster_id;
                map.getSource('spectros').getClusterExpansionZoom(clusterId, (err, zoom) => {
                    if (err) return;
                    map.easeTo({ center: features[0].geometry.coordinates, zoom: zoom });
                });
            });

            // Popup sur point individuel
            map.on('click', 'unclustered-point', (e) => {
                const coords = e.features[0].geometry.coordinates.slice();
                const props = e.features[0].properties;

                new maplibregl.Popup()
                    .setLngLat(coords)
                    .setHTML(`
                        <strong>${props.nom}</strong><br>
                        Labo: ${props.labo}<br>
                        Type: ${props.type}<br>
                        <a href="${props.url}" target="_blank">Fiche technique</a>
                    `)
                    .addTo(map);
            });

            // Filtre via Sidebar
            document.getElementById('filter-type').addEventListener('change', (e) => {
                const val = e.target.value;
                if (val === 'all') {
                    map.setFilter('unclustered-point', ['!', ['has', 'point_count']]);
                } else {
                    map.setFilter('unclustered-point', ['all', ['!', ['has', 'point_count']], ['==', ['get', 'type'], val]]);
                }
            });
        });

        // Switcher de fonds de plan
        document.querySelectorAll('input[name="basemap"]').forEach(input => {
            input.addEventListener('change', (e) => {
                const sourceUrl = sources[e.target.value];
                map.getSource('raster-tiles').setTiles([sourceUrl]);
            });
        });

        // Gestion du panneau latéral
        document.getElementById('toggle-sidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // Bouton 3D (Inclinaison)
        document.getElementById('btn-3d').addEventListener('click', () => {
            const pitch = map.getPitch() === 0 ? 60 : 0;
            map.easeTo({ pitch: pitch, duration: 1000 });
        });

        // Curseur pointeur
        map.on('mouseenter', 'clusters', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'clusters', () => map.getCanvas().style.cursor = '');
        map.on('mouseenter', 'unclustered-point', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'unclustered-point', () => map.getCanvas().style.cursor = '');

    </script>
</body>
</html>
